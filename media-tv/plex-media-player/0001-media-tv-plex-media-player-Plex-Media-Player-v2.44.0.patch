From 0de0ec2c4a69165ca062f9ad153af0bbe650f82b Mon Sep 17 00:00:00 2001
From: Luigi 'Comio' Mantellini <luigi.mantellini@gmail.com>
Date: Tue, 15 Oct 2019 11:04:00 +0200
Subject: [PATCH 1/4] media-tv/plex-media-player: Plex Media Player v2.44.0 is
 now available to all Gentoo Linux users.

See https://forums.plex.tv/t/plex-media-player/120475/89
---
 media-tv/plex-media-player/Manifest           |   6 +-
 .../plex-media-player-2.42.0.1013.ebuild      |   4 +-
 .../plex-media-player-2.44.0.1018.ebuild      | 152 ++++++++++++++++++
 3 files changed, 159 insertions(+), 3 deletions(-)
 create mode 100644 media-tv/plex-media-player/plex-media-player-2.44.0.1018.ebuild

diff --git a/media-tv/plex-media-player/Manifest b/media-tv/plex-media-player/Manifest
index 041d98e..1d83fff 100644
--- a/media-tv/plex-media-player/Manifest
+++ b/media-tv/plex-media-player/Manifest
@@ -4,8 +4,12 @@ AUX git-revision.patch 1184 BLAKE2B e3dbb81fb270fb8d81574529a40d519c9f18d942fdfb
 AUX iconv-fix.patch 336 BLAKE2B ea1d469c75c7cb332c2677156fa9f317840703cb528cd1911836ad933c68351fc0b60d5c750255aa327a97b4088f1d84a5cff0a666826780c078fa4e848d2706 SHA512 7e5d0c119e646528061f48e9feb4a1dfcb0d65fb584f33365a656c143d36ceff1e58e4b39d93890e650b83ccd27c30206a5e4ec2c823be1de6cffe75635b507f
 AUX update-vers.sh 1117 BLAKE2B e05292e6a4be2264b4af801ff3186490c1ebe49f68b662cf8632669d2ff50ccd3e68075b3d46d0f3214a35c88c203bbf612cd8112714b42e2c19b785b8c87ce7 SHA512 307076729a807780347824c4ddbbdd1c675086d7fc7ddfe3738456af82037855f5a198896f01892c79749b4cbdebbc76c78089cb027ab3ca31ad4709671b6757
 DIST buildid-148-aa5f46f1b12c68.cmake 102 BLAKE2B 66b6e5129e586028ad110d332026df4198cf864af1baea750bbe2fdebb214634b3ac08e959a0d13ba31ad64196f15699e0e90c85b752542c60b608ccb85b5840 SHA512 fa85ba5472b42a6775baf659c9aee760b4d0d0dc63a165f6e080b4bf426d54ac65fcf061e4522119917b72ff36ea59e6b1900fab293d9975bd001ba2468119f7
+DIST buildid-151-ce86ded1b12c68.cmake 103 BLAKE2B 38cff1c28dd142937518200efea15939197c924bb51ef169f34ea0ee39c70c1c6a51eefdb7579e06f5b5ebeba9145e383ac1c24138a3711e099463fe70ae87fb SHA512 bbd151fb56ea3df13bece34dc703eb4d2d1c7334f4fba425a6159210121caa23809bfbd54fbfa2a2c7a0b35443af4187c9a76e817ea8ace0fe932303d0ce7956
 DIST plex-media-player-2.42.0.1013.tar.gz 1758971 BLAKE2B fb7b840f46387fad674a44d02fe4eac7d6f54e480ab34717f0b191076f6779530f3bf5fcdda22a19fbd382a474eaa1b8d9c2620ab6016cc1e3714f23f4bed6af SHA512 ef408cb5c2697c8120cb9d9a669128d5634c898c26e9a582e823263e11a294beef9282441b400f3895af696b89cc1b7c421abbcb6861a9db27419147baca552b
+DIST plex-media-player-2.44.0.1018.tar.gz 1759195 BLAKE2B d549a695da37d5d275aa3d8c236b90b0e45eb12e0b8169b26b387cdf1bc8eba4d661b1f802d58b319328b17704674b2a40d0a6b634d56c77e337116f9ad7a685 SHA512 46c13805c947635477454b2d156e5a24b2886e51c87be8977a4306a6fa457b48367bf6b860c475b834261679a1e23c2be67ef98c57cf78a6ebc750327647da6b
 DIST web-client-desktop-3.104.2-1b12c68.tar.xz 3708444 BLAKE2B e82c60957972c301ee11860959f2291661ea8bf1c61e779ff861eccbd4a8a02a2b8ed7813be561db5035805bcd607325a1da3cbea259bc714dff2eb06d6f58ca SHA512 905f13f392acf4ad8e999489adcbe0ad700f09aeabc32258f144d661831ecd69e367af4cfa4e56111094bd18ca212bed3a34bc8bae500927e3f88d817b301dd2
+DIST web-client-tv-4.11.1-ce86ded.tar.xz 4479276 BLAKE2B f7ab37f4368120059fb1f7913c4628630a87ff91ec277ec111b6b1791439dcf45d948510f2751ef64cfa7a7a71643992509219d6d8209f46770cb8e56714998f SHA512 a86432c6be63593def152cc122f8891740cb1b99efc02e712bdeb32a6bfeb7735c05436f5772fbbb88297f7b7a94eb2b56e3d745d7644c0f4cca627de5bb07bc
 DIST web-client-tv-4.7.1-aa5f46f.tar.xz 4469680 BLAKE2B dcfd0e302332a3e10ba053b1cc330d5aad18efa2f91185c3ec64887bea848a9f17fafd9608bbb06aaa89489668ab7bbf0b99509371cdf4ced88318f1d032a354 SHA512 a20317c8a4c92f3e81bdead62efc8a33461adb299959ea34b60e4dd2edf51dca829266ea39bb7f7105bc2a38369438dc05f88f27e2103cb8d9df9aaf21c0517b
-EBUILD plex-media-player-2.42.0.1013.ebuild 4501 BLAKE2B e517bc3d3531c781d28423b4ca6a979fdb715d29c45b355f6f9e8ac945ba54eaf866538630dbd4d2b0c3d4f28d6f4c6f5de8026aa57675dc52891e6947700578 SHA512 f8a3680ada7c79e80d23efd33bbcce580b393135d1f9686f95c69b949b8af23e3dd87abfb64dc0f9a7b63af0f329e4bea1d1680e8ec331ce8c02523acc00abaa
+EBUILD plex-media-player-2.42.0.1013.ebuild 4504 BLAKE2B bdfb3c415045dc72b68de73cd1ea8748fabe9884045c5dabe6993e1acd69c28d55ed547174c37f9de163cf76c06fd3be09d025a4a35988ebce25bcbc2a3d366b SHA512 0f2ff574b6ff7f1fdc56e135bbfa1caf3ad971d11c53f3120fac721e1c68a9ed07b9bff286dfbae37ca24560cd963c5ffb1f838a0c76f8636f232df9e1f71d22
+EBUILD plex-media-player-2.44.0.1018.ebuild 4505 BLAKE2B 400918184a9ab0618a6fafbf4160a41e60adfea1da915099703ff1c779c1c61b0f97dca21a858f8022dfd6eec50d2ffde6bd253b2e3298329cb0a995a36b45fe SHA512 2961e512812d007f9209d548de4bac3af5176fda46c4ab23bbcc3d64dcfa54d823ad31cd94224615aca2968f00cfc9e026804decd24a0773bb4c14925becbf6c
 MISC metadata.xml 501 BLAKE2B 26f31ae5d202786786841ffe186ba10817ec41ffb8727f093600fd9439cbbe79e3777e00fcee27f6dfd2c274c97a8cea642f57b89b31cf1e8e6ec70e299f50e3 SHA512 4eb5e34a6833ec98fa11e79b0e5a5321e1169a6a000ef90fbf9c814366a3332da45c4cf55406d6cd5057903ee6f0ded5cf6246d85e3a4694b4bdd391b63c7ea1
diff --git a/media-tv/plex-media-player/plex-media-player-2.42.0.1013.ebuild b/media-tv/plex-media-player/plex-media-player-2.42.0.1013.ebuild
index c0cf9aa..b1ca5c8 100644
--- a/media-tv/plex-media-player/plex-media-player-2.42.0.1013.ebuild
+++ b/media-tv/plex-media-player/plex-media-player-2.42.0.1013.ebuild
@@ -143,8 +143,8 @@ pkg_preinst() {
 pkg_postinst() {
 	xdg_pkg_postinst
 
-	einfo "The fkmclane/overlay/${CATEGORY}-${PN} will not supported and updated in the next future. Please migrate to comio/plex-overlay or another"
-	einfo "overlay if you prefer in order to have future updates."
+	einfo "The fkmclane/overlay/${CATEGORY}-${PN} will not be supported and updated in the next future. Please migrate to comio/plex-overlay or"
+	einfo "another overlay if you prefer in order to have future updates."
 }
 
 pkg_postrm() {
diff --git a/media-tv/plex-media-player/plex-media-player-2.44.0.1018.ebuild b/media-tv/plex-media-player/plex-media-player-2.44.0.1018.ebuild
new file mode 100644
index 0000000..e6cb818
--- /dev/null
+++ b/media-tv/plex-media-player/plex-media-player-2.44.0.1018.ebuild
@@ -0,0 +1,152 @@
+# Copyright 1999-2019 Gentoo Authors
+# Distributed under the terms of the GNU General Public License v2
+
+EAPI=7
+
+inherit desktop eutils xdg cmake-utils
+
+DESCRIPTION="Next generation Plex Desktop/Embedded Client"
+HOMEPAGE="http://plex.tv/"
+
+# To change on every release bump:
+COMMIT="8f77cbb9"
+WEB_CLIENT_BUILD_ID="151-ce86ded1b12c68"
+WEB_CLIENT_DESKTOP_VERSION="3.104.2-1b12c68"
+WEB_CLIENT_TV_VERSION="4.11.1-ce86ded"
+
+MY_PV="${PV}-${COMMIT}"
+MY_P="${PN}-${MY_PV}"
+
+RESTRICT="mirror download? ( network-sandbox )"
+
+SRC_URI="
+	https://github.com/plexinc/${PN}/archive/v${MY_PV}.tar.gz -> ${P}.tar.gz
+	!download? (
+		https://artifacts.plex.tv/web-client-pmp/${WEB_CLIENT_BUILD_ID}/buildid.cmake -> buildid-${WEB_CLIENT_BUILD_ID}.cmake
+		https://artifacts.plex.tv/web-client-pmp/${WEB_CLIENT_BUILD_ID}/web-client-tv-${WEB_CLIENT_TV_VERSION}.tar.xz
+		desktop? (
+			https://artifacts.plex.tv/web-client-pmp/${WEB_CLIENT_BUILD_ID}/web-client-desktop-${WEB_CLIENT_DESKTOP_VERSION}.tar.xz
+		)
+	)
+"
+
+LICENSE="GPL-2 PMS-EULA"
+SLOT="0"
+KEYWORDS="~amd64 ~x86"
+IUSE="cec +desktop download joystick lirc"
+
+QT_VERSION=5.11.2
+DEPEND="
+	>=dev-qt/qtcore-${QT_VERSION}
+	>=dev-qt/qtnetwork-${QT_VERSION}
+	>=dev-qt/qtxml-${QT_VERSION}
+	>=dev-qt/qtwebchannel-${QT_VERSION}[qml]
+	>=dev-qt/qtwebengine-${QT_VERSION}
+	>=dev-qt/qtdeclarative-${QT_VERSION}
+	>=dev-qt/qtquickcontrols-${QT_VERSION}
+	>=dev-qt/qtx11extras-${QT_VERSION}
+	media-video/mpv[libmpv]
+	virtual/opengl
+	x11-libs/libX11
+	x11-libs/libXrandr
+
+	|| (
+		media-video/ffmpeg[openssl]
+		media-video/ffmpeg[gnutls]
+		media-video/ffmpeg[securetransport]
+	)
+
+	cec? (
+		>=dev-libs/libcec-2.2.0
+	)
+
+	joystick? (
+		media-libs/libsdl2
+		virtual/libiconv
+	)
+"
+
+RDEPEND="
+	${DEPEND}
+
+	lirc? (
+		app-misc/lirc
+	)
+"
+
+PATCHES=(
+	"${FILESDIR}/iconv-fix.patch"
+	"${FILESDIR}/git-revision.patch"
+	"${FILESDIR}/dont_copy_qtwebengine_devtools_resources_pak_file.patch"
+	"${FILESDIR}/dont_start_as_fullscreen_tv_by_default.patch"
+)
+
+S="${WORKDIR}/${MY_P}"
+DEPENDENCIES_DIR="${S}/dependencies"
+
+CMAKE_IN_SOURCE_BUILD=1
+
+src_prepare() {
+	sed -i -e '/^  install(FILES ${QTROOT}\/resources\/qtwebengine_devtools_resources.pak DESTINATION resources)$/d' src/CMakeLists.txt || die
+
+	cmake-utils_src_prepare
+
+	if use download && has network-sandbox $FEATURES; then
+		eerror "You must disable 'network-sandbox' feature in order to use 'download' flag" && die
+	elif ! use download; then
+		# Avoid to download during the build process
+		mkdir -p "${DEPENDENCIES_DIR}"
+		cp "${DISTDIR}/buildid-${WEB_CLIENT_BUILD_ID}.cmake" "${DEPENDENCIES_DIR}"
+		# Desktop client
+		if use desktop; then
+			cp "${DISTDIR}/web-client-desktop-${WEB_CLIENT_DESKTOP_VERSION}.tar.xz" "${DEPENDENCIES_DIR}"
+			sha1sum -b "${DISTDIR}/web-client-desktop-${WEB_CLIENT_DESKTOP_VERSION}.tar.xz" > "${DEPENDENCIES_DIR}/web-client-desktop-${WEB_CLIENT_DESKTOP_VERSION}.tar.xz.sha1"
+			mkdir -p "${DEPENDENCIES_DIR}/universal-web-client-desktop/${WEB_CLIENT_BUILD_ID}"
+			mv "${WORKDIR}/web-client-desktop-${WEB_CLIENT_DESKTOP_VERSION}" "${DEPENDENCIES_DIR}/universal-web-client-desktop/${WEB_CLIENT_BUILD_ID}"
+		fi
+		# Full screen TV client
+		cp "${DISTDIR}/web-client-tv-${WEB_CLIENT_TV_VERSION}.tar.xz" "${DEPENDENCIES_DIR}"
+		sha1sum -b "${DISTDIR}/web-client-tv-${WEB_CLIENT_TV_VERSION}.tar.xz" > "${DEPENDENCIES_DIR}/web-client-tv-${WEB_CLIENT_TV_VERSION}.tar.xz.sha1"
+		mkdir -p "${DEPENDENCIES_DIR}/universal-web-client-tv/${WEB_CLIENT_BUILD_ID}"
+		mv "${WORKDIR}/web-client-tv-${WEB_CLIENT_TV_VERSION}" "${DEPENDENCIES_DIR}/universal-web-client-tv/${WEB_CLIENT_BUILD_ID}"
+	fi
+	eapply_user
+}
+
+src_configure() {
+	local mycmakeargs=(
+		-DENABLE_CEC=$(usex cec)
+		-DENABLE_SDL2=$(usex joystick)
+		-DENABLE_LIRC=$(usex lirc)
+		-DQTROOT="${EPREFIX}/usr/share/qt5"
+		-DWEB_CLIENT_DISABLE_DESKTOP=$(usex desktop "OFF" "ON")
+	)
+
+	export BUILD_NUMBER="${BUILD}"
+	export GIT_REVISION="${COMMIT}"
+
+	cmake-utils_src_configure
+}
+
+src_install() {
+	cmake-utils_src_install
+	wm="$PN-tv" make_session_desktop "Plex Media Player (TV Layout)" "plexmediaplayer" "--tv" "--fullscreen"
+	if use desktop; then
+		wm="$PN-desktop" make_session_desktop "Plex Media Player" "plexmediaplayer" "--desktop" "--fullscreen"
+	fi
+}
+
+pkg_preinst() {
+	xdg_pkg_preinst
+}
+
+pkg_postinst() {
+	xdg_pkg_postinst
+
+	einfo "The fkmclane/overlay/${CATEGORY}-${PN} will not be supported and updated in the next future. Please migrate to comio/plex-overlay or"
+	einfo "another overlay if you prefer in order to have future updates."
+}
+
+pkg_postrm() {
+	xdg_pkg_postrm
+}
-- 
2.23.0

